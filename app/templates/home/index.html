{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Mini-Me{% endblock %}</title>
    {% block head %}
    <meta name="csrf-token" content="{{ csrf_token }}"> <!-- CSRF 토큰 추가 -->
    {% endblock %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header>
        <h1>This is header</h1>
    </header>

    <main>
        {% block animation_elements %}
        <div id="fallingContainer" class="falling-container"></div>
        <div id="balloon" class="balloon">안녕하세요, 당신의 소중한 리뷰를 남겨주세요!</div>
        <div id="userBalloon" class="userBalloon">. . .</div>
        {% endblock %}

        {% block input_container %}
        <div class="input-container">
            <textarea id="textBox" class="textBox" placeholder="Message Here"></textarea>
            <button type="button" class="text-button" id="sendButton">
                <img src="{% static 'images/arrow_top.png' %}" style="width: 7%; min-width: 28px;">
            </button>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // CSRF 토큰 가져오기
                const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
                const csrfToken = csrfMetaTag ? csrfMetaTag.getAttribute('content') : null;

                if (!csrfToken) {
                    console.error("CSRF token not found. Please ensure it is set in the HTML <head>.");
                    return;
                }

                const sendButton = document.getElementById("sendButton");
                const textBox = document.getElementById("textBox");

                sendButton.addEventListener("click", () => {
                    const message = textBox.value;

                    fetch('/chatbot/save_message/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken // CSRF 토큰 사용
                        },
                        body: JSON.stringify({ message: message })
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = '/chatbot/'; // 성공 시 리디렉션
                        } else {
                            console.error('Failed to save message');
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });
        </script>
        {% endblock %}
    </main>
    
    <footer>
        <p>This is Footer</p>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="{% static 'js/animation.js' %}"></script>
</body>
</html>
